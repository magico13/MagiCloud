@page "/"
@using MagiCommon
@using MagiCommon.Models
@using Microsoft.Extensions.Logging

@inject IMagiCloudAPI MagicApi
@inject ILogger<Index> Logger

<Login OnSuccessfulLogin="@OnFilesChanged">
    <Upload OnUploadComplete="@OnFilesChanged" CurrentDirectory="@CurrentFolder"/>
    <SearchBar OnSearch="@OnSearch"/>
    <FilesComponent FileList="@Files" @ref="@FilesComponentRef"/>
</Login>

@code
{
    private FilesComponent FilesComponentRef { get; set; }
    private string CurrentFolder => FilesComponentRef?.CurrentFolder;

    private List<SearchResult> Files { get; set; }

    public async Task OnFilesChanged()
    {
        try
        {
            Files = await MagicApi.GetFilesAsync(false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update file list.");
        }
    }

    public async Task OnSearch(List<SearchResult> results)
    {
        Files = results;
        await Task.CompletedTask;
    }
}